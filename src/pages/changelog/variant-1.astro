---
/**
 * Changelog Variant 1 - Card Grid
 *
 * A Notion/Tailwind UI-inspired card grid changelog with
 * visual previews, category filters, and hover interactions.
 */
import BaseThemeLayout from '@layouts/BaseThemeLayout.astro';
import { getCollection } from 'astro:content';

// Get all changelog entries sorted by date (newest first)
// Within the same date, sort by suffix descending (_04 before _01)
const allEntries = await getCollection('changelog');
const sortedEntries = allEntries
  .filter(entry => entry.data.title && entry.data.date)
  .sort((a, b) => {
    const dateCompare = new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
    if (dateCompare !== 0) return dateCompare;
    // Same date - sort by ID descending (higher suffix first)
    return b.id.localeCompare(a.id);
  });

// Get unique categories for filter
const categories = [...new Set(sortedEntries.map(e => e.data.category).filter(Boolean))];

// Category styling
const categoryConfig: Record<string, { gradient: string; icon: string }> = {
  Feature: { gradient: 'from-emerald-500 to-teal-500', icon: '‚ú®' },
  Component: { gradient: 'from-violet-500 to-purple-500', icon: 'üß©' },
  Refactor: { gradient: 'from-amber-500 to-orange-500', icon: 'üîÑ' },
  Fix: { gradient: 'from-rose-500 to-pink-500', icon: 'üêõ' },
  Documentation: { gradient: 'from-sky-500 to-blue-500', icon: 'üìö' },
  Infrastructure: { gradient: 'from-slate-500 to-gray-500', icon: 'üèóÔ∏è' },
  'Design-System': { gradient: 'from-fuchsia-500 to-pink-500', icon: 'üé®' },
};

function getCategoryConfig(category?: string) {
  return categoryConfig[category || ''] || categoryConfig.Feature;
}

function formatDate(date: Date) {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  }).format(date);
}
---

<BaseThemeLayout title="Changelog | Dark Matter">
  <main class="changelog-page">
    <!-- Hero Header -->
    <header class="changelog-header">
      <div class="max-w-6xl mx-auto px-6 py-16">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-8">
          <div>
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-violet-500/10 border border-violet-500/20 text-violet-400 text-sm mb-6">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              <span>{sortedEntries.length} Updates</span>
            </div>
            <h1 class="text-4xl sm:text-5xl font-bold mb-4">Changelog</h1>
            <p class="text-lg text-foreground/60 max-w-xl">
              New features, improvements, and fixes. Browse our development journey.
            </p>
          </div>

          <!-- Variant Switcher -->
          <div class="flex gap-2">
            <a href="/changelog" class="variant-tab">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
              Timeline
            </a>
            <a href="/changelog/variant-1" class="variant-tab active">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
              </svg>
              Cards
            </a>
            <a href="/changelog/variant-3" class="variant-tab">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              Releases
            </a>
          </div>
        </div>

        <!-- Category Filters -->
        <div class="category-filters mt-8">
          <button class="filter-btn active" data-category="all">All</button>
          {categories.map((cat) => (
            <button class="filter-btn" data-category={cat}>
              <span class="filter-icon">{getCategoryConfig(cat).icon}</span>
              {cat}
            </button>
          ))}
        </div>
      </div>
    </header>

    <!-- Card Grid -->
    <div class="changelog-grid max-w-6xl mx-auto px-6 py-12">
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {sortedEntries.map((entry, index) => {
          const config = getCategoryConfig(entry.data.category);
          const isRecent = index < 3;

          return (
            <article
              class:list={['changelog-card group', { 'featured': isRecent }]}
              data-category={entry.data.category || 'Feature'}
            >
              <!-- Gradient Header -->
              <div class:list={['card-gradient', `bg-gradient-to-br ${config.gradient}`]}>
                <span class="gradient-icon">{config.icon}</span>
                {isRecent && <span class="new-badge">New</span>}
              </div>

              <!-- Card Content -->
              <div class="card-content">
                <div class="card-header">
                  <time class="card-date">{formatDate(new Date(entry.data.date))}</time>
                  {entry.data.category && (
                    <span class="card-category">{entry.data.category}</span>
                  )}
                </div>

                <h3 class="card-title">
                  <a href={`/changelog/${entry.id}`}>{entry.data.title}</a>
                </h3>

                {entry.data.summary && (
                  <p class="card-summary">{entry.data.summary}</p>
                )}

                <!-- Tags Cloud -->
                {entry.data.tags && entry.data.tags.length > 0 && (
                  <div class="card-tags">
                    {entry.data.tags.slice(0, 3).map((tag: string) => (
                      <span class="tag">{tag}</span>
                    ))}
                    {entry.data.tags.length > 3 && (
                      <span class="tag-overflow">+{entry.data.tags.length - 3}</span>
                    )}
                  </div>
                )}

                <!-- Footer -->
                <div class="card-footer">
                  <div class="card-meta">
                    {entry.data.authors && entry.data.authors[0] && (
                      <span class="author">{entry.data.authors[0]}</span>
                    )}
                  </div>
                  <a href={`/changelog/${entry.id}`} class="read-more">
                    Read more
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                  </a>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </div>
  </main>
</BaseThemeLayout>

<script>
  // Category filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const filterBtns = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.changelog-card');

    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const category = btn.dataset.category;

        // Filter cards
        cards.forEach(card => {
          const cardEl = card as HTMLElement;
          if (category === 'all' || cardEl.dataset.category === category) {
            cardEl.style.display = '';
            cardEl.style.animation = 'fadeIn 0.3s ease forwards';
          } else {
            cardEl.style.display = 'none';
          }
        });
      });
    });
  });
</script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .changelog-page {
    background: var(--color-background);
    min-height: 100vh;
  }

  .changelog-header {
    background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
    border-bottom: 1px solid var(--color-border);
  }

  /* Variant Switcher */
  .variant-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: var(--color-foreground);
    opacity: 0.5;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .variant-tab:hover {
    opacity: 0.8;
    background: rgba(139, 92, 246, 0.1);
  }

  .variant-tab.active {
    opacity: 1;
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
  }

  /* Category Filters */
  .category-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-foreground);
    opacity: 0.6;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .filter-btn.active {
    opacity: 1;
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.4);
    color: #a78bfa;
  }

  .filter-icon {
    font-size: 1rem;
  }

  /* Card Grid */
  .changelog-card {
    position: relative;
    border-radius: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.06);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .changelog-card:hover {
    transform: translateY(-4px);
    border-color: rgba(139, 92, 246, 0.3);
    box-shadow: 0 20px 40px -15px rgba(139, 92, 246, 0.15);
  }

  .changelog-card.featured {
    border-color: rgba(139, 92, 246, 0.2);
  }

  /* Card Gradient Header */
  .card-gradient {
    height: 80px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.85;
  }

  .gradient-icon {
    font-size: 2rem;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
  }

  .new-badge {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    padding: 0.125rem 0.5rem;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 9999px;
    color: white;
  }

  /* Card Content */
  .card-content {
    padding: 1.25rem;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .card-date {
    font-size: 0.75rem;
    color: var(--color-foreground);
    opacity: 0.5;
  }

  .card-category {
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.125rem 0.5rem;
    background: rgba(139, 92, 246, 0.1);
    color: #a78bfa;
    border-radius: 0.25rem;
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }

  .card-title a {
    color: var(--color-foreground);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .card-title a:hover {
    color: #a78bfa;
  }

  .card-summary {
    font-size: 0.8125rem;
    color: var(--color-foreground);
    opacity: 0.6;
    line-height: 1.5;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tags */
  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 1rem;
  }

  .tag {
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.25rem;
    color: var(--color-foreground);
    opacity: 0.6;
  }

  .tag-overflow {
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    color: var(--color-foreground);
    opacity: 0.4;
  }

  /* Footer */
  .card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  .author {
    font-size: 0.75rem;
    color: var(--color-foreground);
    opacity: 0.5;
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #a78bfa;
    text-decoration: none;
    transition: gap 0.2s ease;
  }

  .read-more:hover {
    gap: 0.625rem;
  }

  /* Light mode */
  :global([data-mode="light"]) .changelog-header {
    background: linear-gradient(180deg, rgba(108, 99, 255, 0.03) 0%, transparent 100%);
  }

  :global([data-mode="light"]) .changelog-card {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.08);
  }

  :global([data-mode="light"]) .changelog-card:hover {
    border-color: rgba(108, 99, 255, 0.3);
    box-shadow: 0 20px 40px -15px rgba(108, 99, 255, 0.1);
  }

  :global([data-mode="light"]) .filter-btn {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.1);
  }

  :global([data-mode="light"]) .filter-btn.active {
    background: rgba(108, 99, 255, 0.1);
    border-color: rgba(108, 99, 255, 0.3);
    color: #6c63ff;
  }

  :global([data-mode="light"]) .card-category {
    background: rgba(108, 99, 255, 0.08);
    color: #6c63ff;
  }

  :global([data-mode="light"]) .card-title a:hover {
    color: #6c63ff;
  }

  :global([data-mode="light"]) .read-more {
    color: #6c63ff;
  }

  :global([data-mode="light"]) .variant-tab:hover,
  :global([data-mode="light"]) .variant-tab.active {
    background: rgba(108, 99, 255, 0.1);
    border-color: rgba(108, 99, 255, 0.2);
  }
</style>
