---
/**
 * Changelog Index
 *
 * Main changelog page with toggleable views:
 * - Timeline (default): Linear/Stripe-inspired timeline
 * - Cards: Notion/Tailwind UI-inspired card grid
 * - Releases: GitHub releases-inspired (only releases/ folder entries)
 */
import BaseThemeLayout from '@layouts/BaseThemeLayout.astro';
import TimelineLayout from '@layouts/changelog/TimelineLayout.astro';
import CardGridLayout from '@layouts/changelog/CardGridLayout.astro';
import ReleasesLayout from '@layouts/changelog/ReleasesLayout.astro';
import ChangelogViewToggler from '@components/ui/ChangelogViewToggler.astro';
import { getCollection } from 'astro:content';

// Get all changelog entries sorted by date (newest first)
// Within the same date, sort by suffix descending (_04 before _01)
const allEntries = await getCollection('changelog');
const sortedEntries = allEntries
  .filter(entry => entry.data.title && entry.data.date)
  .sort((a, b) => {
    const dateCompare = new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
    if (dateCompare !== 0) return dateCompare;
    // Same date - sort by ID descending (higher suffix first)
    return b.id.localeCompare(a.id);
  });

// Group by month/year for Timeline view
type GroupedEntries = Record<string, typeof sortedEntries>;
const groupedByMonth: GroupedEntries = sortedEntries.reduce((acc, entry) => {
  const date = new Date(entry.data.date);
  const key = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
  if (!acc[key]) acc[key] = [];
  acc[key].push(entry);
  return acc;
}, {} as GroupedEntries);

// Determine initial view from URL param (for shareable links)
const url = new URL(Astro.request.url);
const viewParam = url.searchParams.get('view');
const initialView = ['timeline', 'cards', 'releases'].includes(viewParam || '')
  ? (viewParam as 'timeline' | 'cards' | 'releases')
  : 'timeline';
---

<BaseThemeLayout title="Changelog | Dark Matter">
  <main class="changelog-page">
    <!-- Hero Header -->
    <header class="changelog-header">
      <div class="max-w-4xl mx-auto px-6 py-16 text-center">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-violet-500/10 border border-violet-500/20 text-violet-400 text-sm mb-6">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Development Timeline</span>
        </div>
        <h1 class="text-4xl sm:text-5xl font-bold mb-4 pb-1 bg-gradient-to-r from-white via-violet-200 to-violet-400 bg-clip-text text-transparent">
          Changelog
        </h1>
        <p class="text-lg text-foreground/60 max-w-2xl mx-auto">
          Track the evolution of Dark Matter's design system, components, and features.
          Every commit, every breakthrough, documented.
        </p>

        <!-- View Toggler -->
        <div class="flex justify-center mt-8">
          <ChangelogViewToggler currentView={initialView} />
        </div>
      </div>
    </header>

    <!-- Views Container -->
    <div class="views-container" data-initial-view={initialView}>
      <!-- Timeline View (default) -->
      <TimelineLayout entries={sortedEntries} groupedByMonth={groupedByMonth} />

      <!-- Cards View -->
      <CardGridLayout entries={sortedEntries} />

      <!-- Releases View -->
      <ReleasesLayout entries={sortedEntries} />
    </div>
  </main>
</BaseThemeLayout>

<style>
  .changelog-page {
    background: var(--color-background);
    min-height: 100vh;
  }

  .changelog-header {
    background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
    border-bottom: 1px solid var(--color-border);
  }

  /* Initial view visibility (before JS loads) */
  .views-container[data-initial-view="timeline"] :global([data-view="cards"]),
  .views-container[data-initial-view="timeline"] :global([data-view="releases"]) {
    display: none;
  }

  .views-container[data-initial-view="cards"] :global([data-view="timeline"]),
  .views-container[data-initial-view="cards"] :global([data-view="releases"]) {
    display: none;
  }

  .views-container[data-initial-view="releases"] :global([data-view="timeline"]),
  .views-container[data-initial-view="releases"] :global([data-view="cards"]) {
    display: none;
  }

  /* Light mode adjustments */
  :global([data-mode="light"]) .changelog-header {
    background: linear-gradient(180deg, rgba(108, 99, 255, 0.03) 0%, transparent 100%);
  }
</style>
