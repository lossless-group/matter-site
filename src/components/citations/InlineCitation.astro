---
/**
 * InlineCitation Component
 *
 * Renders an inline citation marker [n] with a hover popover.
 * Uses data attributes to store citation info, with a global popover
 * container that gets populated on hover.
 *
 * Supports light/dark/vibrant modes via CSS custom properties.
 */
import { formatCitationDate } from '@lib/dates';

interface Props {
  /** Sequential index for display (e.g., 1, 2, 3) */
  index: number;
  /** Hex code identifier for the citation */
  hexCode: string;
  /** Title of the source */
  title: string;
  /** URL to the source */
  url: string;
  /** Publication name or domain */
  source?: string;
  /** Published date for display (ISO format: YYYY-MM-DD) */
  publishedDate?: string;
}

const { index, hexCode, title, url, source, publishedDate } = Astro.props;

// Extract domain from URL if no source provided
const displaySource = source || new URL(url).hostname.replace('www.', '');

// Format date from ISO to citation display format (e.g., "2025, Dec 26")
const displayDate = formatCitationDate(publishedDate);
---

<sup
  class="citation-marker"
  tabindex="0"
  role="button"
  data-citation-title={title}
  data-citation-source={displaySource}
  data-citation-url={url}
  data-citation-date={displayDate}
>
  [{index}]
</sup>

<style>
  .citation-marker {
    cursor: help;
    font-weight: 600;
    font-size: 0.75em;
    padding: 0 0.1em;
    border-radius: 2px;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .citation-marker:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  /* ==========================================================================
     LIGHT MODE
     ========================================================================== */
  :global([data-mode="light"]) .citation-marker {
    color: var(--color-marjorelle-purple);
    background: rgba(108, 99, 255, 0.1);
  }

  :global([data-mode="light"]) .citation-marker:hover {
    color: var(--color-marjorelle-purple);
    background: rgba(108, 99, 255, 0.2);
  }

  /* ==========================================================================
     DARK MODE
     ========================================================================== */
  :global([data-mode="dark"]) .citation-marker {
    color: var(--color-lilac);
    background: rgba(156, 133, 223, 0.15);
  }

  :global([data-mode="dark"]) .citation-marker:hover {
    color: var(--color-lilac);
    background: rgba(156, 133, 223, 0.25);
  }

  /* ==========================================================================
     VIBRANT MODE
     ========================================================================== */
  :global([data-mode="vibrant"]) .citation-marker {
    color: var(--color-lilac);
    background: rgba(156, 133, 223, 0.2);
    text-shadow: 0 0 10px rgba(156, 133, 223, 0.5);
  }

  :global([data-mode="vibrant"]) .citation-marker:hover {
    color: var(--color-lilac);
    background: rgba(156, 133, 223, 0.3);
    box-shadow: 0 0 15px rgba(156, 133, 223, 0.3);
  }
</style>

<script>
  // Global citation popover system
  // Creates a single popover element that gets positioned and populated on hover

  function initCitationPopover() {
    // Only create the popover once
    if (document.getElementById('citation-popover-global')) return;

    // Create the global popover element
    const popover = document.createElement('div');
    popover.id = 'citation-popover-global';
    popover.className = 'citation-popover-global';
    popover.innerHTML = `
      <div class="popover-arrow"></div>
      <div class="popover-content">
        <div class="popover-title"></div>
        <div class="popover-source"></div>
        <div class="popover-date"></div>
        <a class="popover-link" target="_blank" rel="noopener noreferrer">
          <span>View Source</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>
    `;

    // Add styles for the global popover
    const style = document.createElement('style');
    style.textContent = `
      .citation-popover-global {
        position: fixed;
        z-index: 99999;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.15s ease, visibility 0.15s ease;
      }
      .citation-popover-global.is-visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .citation-popover-global .popover-arrow {
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        z-index: -1;
      }
      .citation-popover-global .popover-content {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        min-width: 220px;
        max-width: 320px;
        text-align: left;
      }
      .citation-popover-global .popover-title {
        font-size: 0.8125rem;
        font-weight: 500;
        line-height: 1.4;
        margin: 0 0 0.375rem 0;
      }
      .citation-popover-global .popover-source {
        font-size: 0.6875rem;
        margin: 0 0 0.25rem 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .citation-popover-global .popover-date {
        font-size: 0.6875rem;
        margin: 0 0 0.5rem 0;
      }
      .citation-popover-global .popover-date:empty {
        display: none;
      }
      .citation-popover-global .popover-link {
        font-size: 0.75rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0;
      }
      .citation-popover-global .popover-link:hover {
        text-decoration: underline;
      }

      /* Light mode */
      [data-mode="light"] .citation-popover-global .popover-content {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      }
      [data-mode="light"] .citation-popover-global .popover-arrow {
        background: white;
        border-left: 1px solid rgba(0, 0, 0, 0.1);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
      }
      [data-mode="light"] .citation-popover-global .popover-title { color: #1a1a2e; }
      [data-mode="light"] .citation-popover-global .popover-source { color: #6c63ff; opacity: 0.8; }
      [data-mode="light"] .citation-popover-global .popover-date { color: #1a1a2e; opacity: 0.5; }
      [data-mode="light"] .citation-popover-global .popover-link { color: #6c63ff; }

      /* Dark mode */
      [data-mode="dark"] .citation-popover-global .popover-content {
        background: rgba(15, 9, 35, 0.98);
        border: 1px solid rgba(156, 133, 223, 0.25);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
      }
      [data-mode="dark"] .citation-popover-global .popover-arrow {
        background: rgba(15, 9, 35, 0.98);
        border-left: 1px solid rgba(156, 133, 223, 0.25);
        border-top: 1px solid rgba(156, 133, 223, 0.25);
      }
      [data-mode="dark"] .citation-popover-global .popover-title { color: #f5f5f5; }
      [data-mode="dark"] .citation-popover-global .popover-source { color: #9c85df; opacity: 0.8; }
      [data-mode="dark"] .citation-popover-global .popover-date { color: #f5f5f5; opacity: 0.5; }
      [data-mode="dark"] .citation-popover-global .popover-link { color: #9c85df; }

      /* Vibrant mode */
      [data-mode="vibrant"] .citation-popover-global .popover-content {
        background: linear-gradient(135deg, rgba(15, 9, 35, 0.98), rgba(26, 10, 53, 0.95));
        border: 1px solid rgba(156, 133, 223, 0.4);
        box-shadow: 0 4px 40px rgba(102, 67, 226, 0.3);
      }
      [data-mode="vibrant"] .citation-popover-global .popover-arrow {
        background: rgba(15, 9, 35, 0.98);
        border-left: 1px solid rgba(156, 133, 223, 0.4);
        border-top: 1px solid rgba(156, 133, 223, 0.4);
      }
      [data-mode="vibrant"] .citation-popover-global .popover-title { color: #f5f5f5; }
      [data-mode="vibrant"] .citation-popover-global .popover-source { color: #9c85df; }
      [data-mode="vibrant"] .citation-popover-global .popover-date { color: #f5f5f5; opacity: 0.6; }
      [data-mode="vibrant"] .citation-popover-global .popover-link { color: #9c85df; }
    `;
    document.head.appendChild(style);
    document.body.appendChild(popover);

    // Get popover elements
    const arrow = popover.querySelector('.popover-arrow') as HTMLElement;
    const titleEl = popover.querySelector('.popover-title') as HTMLElement;
    const sourceEl = popover.querySelector('.popover-source') as HTMLElement;
    const dateEl = popover.querySelector('.popover-date') as HTMLElement;
    const linkEl = popover.querySelector('.popover-link') as HTMLAnchorElement;

    let hideTimeout: ReturnType<typeof setTimeout> | null = null;
    let currentMarker: HTMLElement | null = null;

    function showPopover(marker: HTMLElement) {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }

      currentMarker = marker;

      // Populate from data attributes
      titleEl.textContent = marker.dataset.citationTitle || '';
      sourceEl.textContent = marker.dataset.citationSource || '';
      dateEl.textContent = marker.dataset.citationDate || '';
      linkEl.href = marker.dataset.citationUrl || '#';

      // Position the popover
      const rect = marker.getBoundingClientRect();

      // First show invisibly to measure
      popover.style.visibility = 'hidden';
      popover.style.opacity = '0';
      popover.classList.add('is-visible');

      requestAnimationFrame(() => {
        const popoverRect = popover.getBoundingClientRect();

        let left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
        let top = rect.bottom + 8;

        // Keep in viewport
        const padding = 12;
        if (left < padding) left = padding;
        if (left + popoverRect.width > window.innerWidth - padding) {
          left = window.innerWidth - popoverRect.width - padding;
        }

        // Flip above if needed
        if (top + popoverRect.height > window.innerHeight - padding) {
          top = rect.top - popoverRect.height - 8;
          arrow.style.top = 'auto';
          arrow.style.bottom = '-6px';
        } else {
          arrow.style.top = '-6px';
          arrow.style.bottom = 'auto';
        }

        popover.style.left = `${left}px`;
        popover.style.top = `${top}px`;
        popover.style.visibility = '';
        popover.style.opacity = '';
      });
    }

    function hidePopover() {
      hideTimeout = setTimeout(() => {
        popover.classList.remove('is-visible');
        currentMarker = null;
      }, 150);
    }

    // Event delegation for all citation markers
    document.addEventListener('mouseenter', (e) => {
      const marker = (e.target as HTMLElement).closest('.citation-marker');
      if (marker) showPopover(marker as HTMLElement);
    }, true);

    document.addEventListener('mouseleave', (e) => {
      const marker = (e.target as HTMLElement).closest('.citation-marker');
      if (marker) hidePopover();
    }, true);

    // Keep popover open when hovering over it
    popover.addEventListener('mouseenter', () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
    });

    popover.addEventListener('mouseleave', hidePopover);

    // Focus events
    document.addEventListener('focusin', (e) => {
      const marker = (e.target as HTMLElement).closest('.citation-marker');
      if (marker) showPopover(marker as HTMLElement);
    });

    document.addEventListener('focusout', (e) => {
      const marker = (e.target as HTMLElement).closest('.citation-marker');
      if (marker) hidePopover();
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCitationPopover);
  } else {
    initCitationPopover();
  }
  document.addEventListener('astro:page-load', initCitationPopover);
</script>
