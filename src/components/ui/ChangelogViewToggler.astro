---
/**
 * Changelog View Toggler
 *
 * Toggle buttons to switch between Timeline, Cards, and Releases views.
 * Includes a share button that copies a URL with the view parameter.
 */
import ButtonDefault from '@components/basics/buttons/Button--Default.astro';

interface Props {
  currentView?: 'timeline' | 'cards' | 'releases';
}

const { currentView = 'timeline' } = Astro.props;
---

<div class="view-toggler" data-current-view={currentView}>
  <div class="toggle-group">
    <ButtonDefault active={currentView === 'timeline'} data-view="timeline">
      <svg slot="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      Timeline
    </ButtonDefault>

    <ButtonDefault active={currentView === 'cards'} data-view="cards">
      <svg slot="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
      </svg>
      Cards
    </ButtonDefault>

    <ButtonDefault active={currentView === 'releases'} data-view="releases">
      <svg slot="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
      </svg>
      Releases
    </ButtonDefault>
  </div>

  <button class="share-btn" title="Copy link to this view">
    <svg class="share-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
    </svg>
    <svg class="check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
  </button>
</div>

<script>
  function initViewToggler() {
    const toggler = document.querySelector('.view-toggler') as HTMLElement;
    if (!toggler) return;

    const viewBtns = toggler.querySelectorAll('[data-view]');
    const shareBtn = toggler.querySelector('.share-btn');
    const viewsContainer = document.querySelector('.views-container') as HTMLElement;

    // Remove CSS-based initial visibility control so JS can take over
    if (viewsContainer) {
      viewsContainer.removeAttribute('data-initial-view');
    }

    // Get all layout containers (not buttons)
    const layouts = document.querySelectorAll('.timeline-layout, .cardgrid-layout, .releases-layout');

    // Get initial view from URL or default
    const urlParams = new URLSearchParams(window.location.search);
    const initialView = urlParams.get('view') || toggler.dataset.currentView || 'timeline';

    // Set initial state
    setActiveView(initialView);

    // Handle view button clicks
    viewBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = (btn as HTMLElement).dataset.view;
        if (view) {
          setActiveView(view);
        }
      });
    });

    // Handle share button click
    shareBtn?.addEventListener('click', async () => {
      const currentView = toggler.dataset.currentView || 'timeline';
      const url = new URL(window.location.href);
      url.searchParams.set('view', currentView);

      try {
        await navigator.clipboard.writeText(url.toString());

        // Show success state
        const shareIcon = shareBtn.querySelector('.share-icon');
        const checkIcon = shareBtn.querySelector('.check-icon');
        shareIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');

        // Reset after 2 seconds
        setTimeout(() => {
          shareIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy URL:', err);
      }
    });

    function setActiveView(view: string) {
      // Update toggler state
      toggler.dataset.currentView = view;

      // Update button states
      viewBtns.forEach(btn => {
        const btnView = (btn as HTMLElement).dataset.view;
        btn.classList.toggle('active', btnView === view);
      });

      // Show/hide layouts
      layouts.forEach(layout => {
        const layoutEl = layout as HTMLElement;
        const layoutView = layoutEl.dataset.view;
        if (layoutView) {
          layoutEl.style.display = layoutView === view ? '' : 'none';
        }
      });
    }
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', initViewToggler);

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initViewToggler);
</script>

<style>
  .view-toggler {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toggle-group {
    display: flex;
    gap: 0.25rem;
  }

  .share-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    color: var(--color-foreground);
    opacity: 0.5;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .share-btn:hover {
    opacity: 0.8;
    background: rgba(139, 92, 246, 0.1);
  }

  .share-btn svg {
    width: 1rem;
    height: 1rem;
  }

  .share-btn .check-icon {
    color: #10b981;
  }

  .hidden {
    display: none;
  }

  /* Light mode */
  :global([data-mode="light"]) .share-btn:hover {
    background: rgba(108, 99, 255, 0.1);
  }
</style>
